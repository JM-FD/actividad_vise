name: CI

on:
  workflow_dispatch:
    inputs:
      PORT:
        description: 'Puerto de la API'
        required: true
        default: '3000'

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Build app
        run: npm run build

      - name: Build Docker image
        run: docker build -t vise-api:latest .

      - name: Run container
        run: |
          echo "ğŸ”¹ Levantando contenedor..."
          docker run -d -p ${{ github.event.inputs.PORT }}:${{ github.event.inputs.PORT }} --name vise-api vise-api:latest
          echo "â³ Esperando 5s para que arranque..."
          sleep 5
          echo "ğŸ”¹ Listando contenedores..."
          docker ps -a
          echo "ğŸ”¹ Logs del contenedor..."
          docker logs vise-api || true
          echo "ğŸ”¹ Probando conexiÃ³n con curl..."
          curl -v http://localhost:${{ github.event.inputs.PORT }}/ || true

      - name: Run Hurl tests
        run: |
          echo "ğŸ”¹ Ejecutando pruebas con Hurl..."
          hurl --variable host=http://localhost:${{ github.event.inputs.PORT }} \
               --error-format long \
               --verbose \
               --test session.hurl
